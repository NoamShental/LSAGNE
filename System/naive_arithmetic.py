import pandas as pd
import numpy as np
import os
import string
from data_handler import DataHandler
from latent_space_arithmetic import LatentSpaceArithmetic
from statistics_calculator import StatisticsCalculator
from configuration import config
from types import MethodType

calculate_top_genes_only = True
top_genes = {"geldanamycin": {"A375 skin malignant melanoma": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "79902", "5154", "2597", "6182", "23597", "6195", "2109", "9801", "5710", "11344", "54881", "2146", "23658", "9847", "10362", "8318", "84617", "5782", "672", "8870", "10921", "2736", "5300", "57019", "9928", "23244", "5331", "79073", "55012", "90861", "6894", "25839", "29937", "6390", "11004", "4860", "11007", "1802", "8985", "23325", "23326", "5925", "22823", "5427", "10038", "10557", "4927", "5440", "1861", "10059", "332", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "8050", "7027", "8061", "51071", "10112", "11137", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "8624", "1978", "1983", "7106", "6597", "965", "983", "9695", "993", "23013", "6118", "79850", "2542", "7153", "5111", "4605"], "A549 lung non small cell lung cancer| carcinoma": ["51203", "9221", "2058", "8204", "23061", "2582", "79902", "5154", "2597", "6182", "23597", "6195", "2109", "10813", "9801", "4172", "8270", "11344", "54881", "2146", "23658", "9847", "10362", "8318", "5782", "672", "8870", "10921", "2736", "5300", "4282", "57019", "9928", "23244", "5331", "79073", "55012", "90861", "25839", "29937", "6390", "11004", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "5427", "10038", "10557", "5440", "1861", "8520", "10059", "332", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "7027", "8061", "51071", "10112", "11137", "3978", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "8624", "10682", "1978", "1983", "7106", "6597", "965", "51160", "9695", "993", "23013", "6118", "79850", "2542", "5111", "1017", "4605"], "HA1E kidney normal kidney": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "79902", "5154", "2597", "6182", "6184", "23597", "6195", "10813", "9801", "4172", "11344", "54881", "2146", "23658", "9847", "10362", "8318", "50814", "5782", "672", "8870", "10921", "2736", "5300", "4282", "9928", "23244", "207", "5331", "79073", "55012", "90861", "6894", "25839", "29937", "6390", "11004", "4860", "11007", "1802", "8985", "23325", "23326", "5925", "22823", "10038", "10557", "4927", "5440", "1861", "10059", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "7027", "8061", "51071", "10112", "11137", "387", "55699", "22934", "26520", "51097", "5018", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "8624", "1978", "1983", "7106", "965", "6597", "9695", "993", "23013", "6118", "79850", "2542", "5111", "1017", "4605"], "HCC515 lung carcinoma": ["91137", "51203", "9221", "2058", "8204", "23061", "2582", "79902", "5154", "2597", "6182", "6184", "23597", "1070", "6195", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "23658", "9847", "10362", "8318", "5782", "4775", "10921", "2736", "50865", "5300", "57019", "9928", "1738", "23244", "5331", "79073", "55012", "90861", "25839", "29937", "6390", "11004", "4860", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "10038", "10557", "5440", "1861", "10059", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "8061", "51071", "11137", "899", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "64429", "9133", "8624", "10682", "1978", "1983", "7106", "6597", "965", "9688", "993", "23013", "6118", "2542", "5111", "1017", "4605"], "HEPG2 liver hepatocellular carcinoma": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "79902", "2597", "6182", "9261", "1070", "23597", "6195", "10813", "2109", "9801", "5710", "11344", "54881", "2146", "23658", "9847", "10362", "50814", "5782", "10921", "50865", "5300", "57019", "5827", "9928", "1738", "23244", "207", "5331", "79073", "55012", "90861", "25839", "6390", "11004", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "10038", "10557", "4927", "5440", "1861", "10059", "332", "51021", "51024", "51026", "3925", "7511", "57178", "5982", "55148", "8050", "7027", "8574", "51071", "10112", "11137", "387", "3978", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "64429", "9133", "64943", "8624", "1978", "1983", "7106", "965", "6597", "9688", "994", "23013", "6118", "79850", "2542", "1017", "4605"], "HT29 large intestine colorectal adenocarcinoma": ["51203", "9221", "2058", "8204", "2582", "79902", "5154", "2597", "6182", "2109", "10813", "9801", "4172", "5710", "8270", "11344", "54881", "3682", "2146", "23658", "9847", "10362", "8318", "5782", "672", "8870", "10921", "2736", "5300", "4282", "57019", "9928", "23244", "5331", "79071", "79073", "5347", "55012", "90861", "25839", "6390", "11004", "4860", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "5427", "10038", "10557", "5440", "1861", "10059", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "7027", "8061", "51071", "10112", "11137", "3978", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "8624", "10682", "1978", "1983", "7106", "6597", "965", "51160", "9695", "993", "23013", "6118", "79850", "2542", "5111", "1017", "4605"], "MCF7 breast adenocarcinoma": ["91137", "51203", "9221", "2058", "9738", "8204", "2582", "5154", "2597", "6182", "23597", "6195", "10813", "9801", "4172", "8270", "5710", "11344", "54881", "2146", "23658", "58478", "9847", "10362", "8318", "5782", "672", "8870", "10921", "2736", "50865", "5300", "57019", "9928", "1738", "23244", "5331", "79073", "55012", "90861", "25839", "6390", "4860", "11004", "11007", "1802", "8985", "23325", "23326", "5925", "22823", "10038", "10557", "5440", "1861", "10059", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "7027", "8061", "51071", "10112", "11137", "387", "3978", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "8624", "10682", "1978", "54205", "1983", "7106", "6597", "965", "9688", "9695", "23013", "6118", "79850", "2542", "5111", "1017", "4605"], "PC3 prostate adenocarcinoma": ["91137", "51203", "9221", "8204", "8726", "2582", "79902", "5154", "2597", "6182", "6184", "23597", "6195", "2109", "10813", "9801", "4172", "5710", "8270", "11344", "54881", "2146", "23658", "58478", "9847", "10362", "8318", "5782", "672", "8870", "10921", "50865", "5300", "4282", "57019", "9928", "23244", "5331", "79073", "5347", "55012", "90861", "25839", "29937", "6390", "11004", "55038", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "5427", "10038", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "7027", "8061", "51071", "10112", "11137", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "9133", "64943", "8624", "10682", "1978", "1983", "7106", "6597", "965", "9695", "993", "23013", "6118", "79850", "2542", "5111", "1017", "4605"], "VCAP prostate carcinoma": ["51203", "9221", "2058", "8204", "23061", "2582", "79902", "5154", "2597", "6182", "6184", "23597", "6195", "2109", "10813", "9801", "4172", "5710", "11344", "5720", "54881", "3682", "2146", "23658", "9847", "10362", "8318", "5782", "672", "10921", "2736", "5300", "4282", "57019", "9928", "1738", "23244", "5331", "79073", "55012", "90861", "6894", "25839", "29937", "6390", "11004", "11007", "1802", "22796", "8985", "23325", "23326", "5925", "22823", "10038", "10557", "4927", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "55148", "7027", "8061", "51071", "10112", "11137", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "9133", "64943", "10682", "1978", "1983", "7106", "6597", "965", "51160", "9695", "993", "23013", "6118", "79850", "2542", "5111", "1017", "4605"]}, "raloxifene": {"A375 skin malignant melanoma": ["91137", "51203", "9221", "51719", "2058", "9738", "8204", "23061", "2582", "10776", "25", "51742", "5154", "2597", "9261", "23597", "10813", "9801", "60493", "8270", "5710", "1616", "11344", "54881", "2146", "4200", "23658", "2673", "9847", "8312", "1662", "644", "2195", "4775", "10921", "2736", "50865", "5300", "57019", "9928", "1738", "23244", "10972", "5347", "55012", "90861", "25839", "6390", "7416", "55033", "11007", "8985", "23326", "1829", "22823", "10038", "9531", "10557", "5440", "1861", "51026", "3925", "7511", "5982", "5993", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "899", "2954", "55699", "1429", "22934", "26520", "93594", "29082", "1445", "9128", "51116", "64429", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "6599", "9688", "9695", "23522", "23013", "998", "2542", "2553"], "A549 lung non small cell lung cancer| carcinoma": ["91137", "51203", "9221", "51719", "9738", "8204", "23061", "2582", "10776", "25", "51742", "5154", "2597", "6184", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "644", "2195", "5287", "4775", "10921", "2736", "50865", "5300", "57019", "9928", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "29937", "7416", "55033", "11007", "8985", "23325", "23326", "5925", "1829", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "899", "2954", "55699", "1429", "22934", "26520", "29082", "93594", "1445", "9128", "51116", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "9695", "23522", "23013", "2542", "2553"], "HA1E kidney normal kidney": ["91137", "51203", "9221", "51719", "9738", "8204", "23061", "2582", "25", "51742", "5154", "2597", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "644", "2195", "4775", "10921", "2736", "50865", "5300", "4282", "57019", "9928", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "29937", "6390", "7416", "11007", "8985", "23325", "23326", "5925", "1829", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "899", "2954", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "6599", "9695", "23522", "23013", "2542", "2553"], "HCC515 lung carcinoma": ["91137", "51203", "9221", "51719", "9738", "8204", "23061", "2582", "25", "51742", "5154", "2597", "6184", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "644", "84617", "2195", "4775", "5287", "10921", "2736", "50865", "5300", "57019", "9928", "23244", "5331", "5347", "55012", "90861", "25839", "29937", "6390", "7416", "55033", "11004", "11007", "8985", "23325", "23326", "1829", "5925", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "351", "55148", "51569", "8050", "7027", "51071", "11137", "899", "2954", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "10682", "1978", "1983", "7106", "965", "9695", "23013", "2542", "2553"], "HEPG2 liver hepatocellular carcinoma": ["91137", "51203", "9221", "51719", "2058", "9738", "8204", "23061", "8726", "2582", "10776", "25", "51742", "5154", "2597", "9261", "23597", "6195", "9801", "8270", "5710", "1616", "11344", "54881", "2146", "4200", "23658", "2673", "9847", "8312", "50814", "644", "2195", "10915", "10921", "2736", "50865", "3251", "5300", "4282", "57019", "9928", "1738", "23244", "10972", "5347", "55012", "90861", "25839", "29937", "6390", "55033", "11004", "8985", "23325", "23326", "5925", "22823", "10038", "9531", "10557", "5440", "1861", "3925", "51031", "7511", "5982", "55148", "51569", "8050", "7027", "10617", "10112", "11137", "387", "899", "2954", "55699", "1429", "22934", "26520", "93594", "29082", "1445", "9128", "51116", "64429", "9133", "10682", "1978", "1983", "7106", "6597", "965", "6599", "9688", "23013", "79850", "2542", "2553"], "HT29 large intestine colorectal adenocarcinoma": ["91137", "51203", "9221", "51719", "2058", "9738", "8204", "23061", "2582", "10776", "25", "51742", "5154", "2597", "6184", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "2195", "4775", "5287", "10921", "2736", "50865", "5300", "4282", "57019", "9928", "23244", "5331", "5347", "55012", "90861", "25839", "6390", "7416", "11004", "11007", "8985", "23325", "23326", "1829", "5925", "22823", "55604", "9531", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "51071", "11137", "899", "2954", "55699", "5525", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "9695", "23013", "2542", "2553"], "MCF7 breast adenocarcinoma": ["91137", "51203", "9221", "51719", "9738", "8204", "23061", "2582", "10776", "25", "51742", "5154", "2597", "6184", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "6777", "10362", "50814", "8318", "644", "84617", "4775", "5287", "10921", "2736", "50865", "5300", "57019", "9928", "23244", "5331", "5347", "55012", "90861", "25839", "7416", "11007", "8985", "23325", "23326", "1829", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "351", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "899", "2954", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "9695", "23522", "23013", "2542", "2553"], "PC3 prostate adenocarcinoma": ["91137", "51203", "9221", "51719", "9738", "8204", "23061", "2582", "10776", "25", "5154", "2597", "6184", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "6777", "10362", "50814", "644", "4775", "5287", "10921", "2736", "50865", "5300", "57019", "9928", "23244", "5331", "5347", "55012", "90861", "25839", "29937", "7416", "55033", "11004", "11007", "22796", "8985", "23325", "23326", "5925", "1829", "22823", "9531", "10557", "831", "5440", "1861", "10059", "51026", "3925", "7511", "57178", "5982", "351", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "899", "2954", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "9133", "29103", "10682", "1978", "1983", "7106", "6597", "965", "9695", "23013", "2542"]}, "vorinostat": {"A375 skin malignant melanoma": ["7168", "1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "7750", "10318", "595", "23636", "9817", "10329", "10845", "7264", "1633", "1635", "9833", "23658", "3693", "622", "8349", "672", "10915", "4775", "3251", "4282", "57019", "7866", "7874", "6342", "9926", "9928", "207", "27346", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "23326", "83743", "23338", "7982", "5427", "10038", "11065", "3385", "10557", "10051", "7494", "332", "51021", "23378", "51031", "874", "10606", "8050", "80758", "890", "10112", "899", "2954", "3978", "11157", "22934", "26520", "51097", "10146", "1445", "51116", "9133", "8624", "10165", "10174", "55748", "965", "6599", "54733", "10190", "466", "983", "55256", "993", "79850", "7153", "7157", "4088", "2553", "10237", "23039"], "A549 lung non small cell lung cancer| carcinoma": ["1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "595", "23636", "10329", "9817", "5211", "10845", "7264", "1633", "2146", "1635", "9833", "23658", "3693", "622", "9847", "672", "10915", "4775", "3251", "4282", "57019", "7866", "7874", "6342", "9926", "9928", "23244", "207", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "83743", "11041", "23338", "7982", "5427", "2356", "10038", "11065", "3385", "10557", "10051", "7494", "332", "51021", "23378", "51031", "10606", "8050", "80758", "890", "10112", "899", "3978", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "55748", "965", "26054", "6599", "54733", "10190", "466", "983", "55256", "993", "23522", "79850", "7153", "7157", "2553", "10237", "23039"], "HA1E kidney normal kidney": ["8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "7750", "10318", "595", "23636", "10329", "9817", "5211", "10845", "7264", "1633", "2146", "1635", "9833", "23658", "3693", "622", "9847", "672", "10915", "4775", "3251", "7866", "4282", "7874", "6342", "9926", "9928", "23244", "207", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "83743", "23338", "7982", "5427", "310", "10038", "3385", "11065", "10557", "10051", "7494", "332", "51021", "23378", "51031", "8050", "80758", "890", "10112", "3978", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "55748", "6597", "26054", "6599", "965", "10190", "466", "9686", "983", "55256", "991", "993", "23522", "79850", "7153", "7157", "4088", "2553", "10237", "23039"], "HCC515 lung carcinoma": ["9217", "1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "7750", "10318", "23636", "10329", "9817", "5211", "10845", "7264", "1633", "2146", "1635", "9833", "23658", "3693", "622", "9847", "672", "10915", "4775", "3251", "4282", "57019", "7866", "7874", "9928", "23244", "207", "27346", "10973", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "23338", "7982", "5427", "2356", "10038", "3385", "10557", "10051", "7494", "332", "51021", "23378", "51031", "10606", "8050", "80758", "890", "10112", "899", "3978", "11157", "22934", "26520", "51097", "10146", "1445", "51116", "9133", "8624", "10165", "55748", "965", "26054", "6599", "54733", "466", "9686", "983", "55256", "991", "993", "79850", "7153", "7157", "4088", "2553", "10237", "23039"], "HT29 large intestine colorectal adenocarcinoma": ["1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "7750", "10318", "23636", "10329", "9817", "5211", "10845", "7264", "1633", "1635", "9833", "23658", "3693", "622", "9847", "672", "10915", "3251", "6839", "4282", "57019", "7866", "7874", "9926", "6342", "9928", "23244", "207", "27346", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "83743", "23338", "7982", "5427", "10038", "3385", "11065", "10557", "10051", "7494", "332", "51021", "10606", "8050", "80758", "890", "10112", "899", "3978", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "55748", "965", "26054", "6599", "54733", "10190", "466", "983", "55256", "991", "993", "23522", "5092", "79850", "7153", "7157", "4088", "2553", "10237", "23039"], "MCF7 breast adenocarcinoma": ["1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "56889", "4154", "7750", "10318", "23636", "10329", "9817", "5211", "7264", "1633", "1635", "9833", "23658", "3693", "9847", "672", "10915", "4775", "3251", "4282", "7866", "7874", "9926", "6342", "9928", "207", "27346", "2778", "10973", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "83743", "23338", "7982", "5427", "10038", "11065", "3385", "10557", "10051", "7494", "332", "51021", "23378", "51031", "874", "10606", "8050", "80758", "890", "10112", "899", "3978", "11157", "22934", "9112", "26520", "51097", "10146", "1445", "51116", "9133", "8624", "10165", "55748", "965", "26054", "6599", "54733", "10190", "466", "983", "55256", "991", "993", "5092", "79850", "7153", "7157", "2553", "10237", "23039"], "PC3 prostate adenocarcinoma": ["1027", "8204", "2064", "8726", "10776", "10270", "5154", "6697", "10797", "3638", "56889", "4154", "7750", "595", "23636", "10329", "9817", "5211", "1633", "2146", "1635", "9833", "23658", "3693", "622", "9847", "672", "10915", "4775", "3251", "6839", "4282", "7866", "7874", "6342", "9926", "9928", "207", "27346", "10973", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "83743", "11041", "23338", "7982", "5427", "10038", "3385", "11065", "10557", "10051", "7494", "332", "55127", "51031", "10606", "8050", "80758", "890", "10112", "899", "3978", "11157", "22934", "9112", "26520", "51097", "10146", "1445", "51116", "9133", "8624", "10165", "10174", "55748", "965", "26054", "6599", "54733", "10190", "466", "983", "55256", "991", "993", "79850", "7153", "2553", "10237", "23039"], "VCAP prostate carcinoma": ["7168", "4609", "8204", "2064", "8726", "10776", "79902", "10270", "5154", "2597", "1062", "6697", "10797", "56889", "4154", "7750", "10318", "595", "23636", "5720", "10329", "9817", "5211", "10845", "2146", "1635", "23658", "3693", "9847", "672", "10915", "3251", "7866", "57019", "4282", "7874", "6342", "9926", "9928", "23244", "207", "8914", "5347", "55012", "7398", "90861", "6894", "10491", "55038", "3329", "1802", "22809", "23326", "11041", "23338", "5427", "10038", "11065", "10557", "4927", "7494", "332", "51021", "51026", "51031", "55148", "8050", "7027", "80758", "890", "10112", "3978", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "55748", "965", "26054", "6599", "10190", "466", "983", "55256", "991", "993", "23522", "5092", "79850", "7153", "7157", "2553", "10237", "23039"]}, "trichostatin-a": {"A375 skin malignant melanoma": ["7168", "1027", "8204", "2064", "8726", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "1633", "1635", "9833", "3693", "622", "5236", "9847", "50810", "1666", "6790", "8349", "672", "10915", "3251", "6839", "7866", "4282", "7874", "8900", "6342", "9926", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "7982", "5427", "10038", "3385", "11065", "4927", "10051", "7494", "332", "51021", "51031", "874", "10606", "8050", "80758", "890", "8061", "10112", "85377", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "10174", "55748", "965", "26054", "6599", "54733", "466", "983", "55256", "9181", "991", "993", "994", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "A549 lung non small cell lung cancer| carcinoma": ["7168", "4609", "1027", "8204", "2064", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "1633", "1635", "9833", "3693", "622", "5236", "9847", "1666", "6790", "8349", "672", "10915", "3251", "6839", "7866", "4282", "7874", "6342", "9926", "9928", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "5427", "310", "10038", "11065", "4927", "10051", "7494", "332", "51021", "51031", "874", "10606", "8050", "80758", "890", "8061", "10112", "25987", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "10174", "7105", "55748", "965", "26054", "6599", "54733", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "HA1E kidney normal kidney": ["4609", "8204", "2064", "8726", "79902", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "5211", "1633", "1635", "9833", "23658", "3693", "622", "5236", "9847", "1666", "672", "10915", "3251", "7866", "4282", "7358", "7874", "8900", "9926", "6342", "9928", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "7982", "5427", "310", "10038", "11065", "4927", "10051", "7494", "332", "51021", "51031", "8050", "7027", "80758", "890", "10112", "85377", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "1978", "7105", "55748", "965", "26054", "6599", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "HCC515 lung carcinoma": ["7168", "4609", "1027", "8204", "2064", "8726", "10270", "5154", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "5211", "1633", "3682", "1635", "9833", "3693", "622", "5236", "9847", "1666", "8349", "672", "10915", "3251", "6839", "7866", "4282", "25793", "7874", "9928", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "7982", "5427", "310", "10038", "3385", "4927", "10051", "7494", "332", "51021", "51031", "10606", "8050", "80758", "890", "8061", "10112", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "1978", "7105", "55748", "965", "26054", "6599", "54733", "466", "9686", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "HEPG2 liver hepatocellular carcinoma": ["7168", "8204", "2064", "8726", "10776", "79902", "10270", "5154", "10276", "6697", "10797", "56889", "4154", "7750", "10318", "23636", "10329", "9817", "5211", "7264", "1635", "9833", "23658", "3693", "5236", "9847", "1666", "672", "10915", "3251", "4282", "25793", "7874", "9926", "6342", "9928", "207", "5347", "55012", "7398", "90861", "6894", "8440", "10491", "55038", "3329", "11014", "22809", "23326", "30001", "310", "10038", "3385", "10557", "4927", "7494", "840", "332", "51021", "23378", "51031", "3930", "8050", "80758", "890", "10112", "85377", "899", "3978", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "1978", "7105", "55748", "6597", "965", "6599", "466", "9686", "983", "9181", "991", "993", "994", "5092", "79850", "7153", "5108", "4088", "2553", "1019", "23039"], "HT29 large intestine colorectal adenocarcinoma": ["4609", "1026", "1027", "8204", "2064", "79902", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "1633", "3682", "1635", "9833", "3693", "622", "5236", "9847", "6790", "8349", "672", "10915", "3251", "6839", "7866", "4282", "7874", "9926", "6342", "9928", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "7982", "5427", "310", "10038", "11065", "5438", "4927", "10051", "7494", "332", "51021", "8050", "80758", "890", "8061", "10112", "85377", "25987", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "7105", "55748", "965", "26054", "6599", "54733", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "MCF7 breast adenocarcinoma": ["7168", "1027", "8204", "2064", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "5211", "1633", "3682", "1635", "9833", "3693", "622", "5236", "9847", "50810", "1666", "6790", "672", "10915", "3251", "6839", "7866", "4282", "7358", "7874", "9926", "6342", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "23338", "7982", "5427", "310", "10038", "11065", "4927", "10051", "7494", "332", "51021", "51031", "874", "8050", "7027", "80758", "890", "10112", "25987", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "7105", "55748", "965", "26054", "6599", "54733", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"], "PC3 prostate adenocarcinoma": ["1027", "8204", "2064", "8726", "10270", "5154", "10276", "6697", "10797", "3638", "56889", "4154", "10318", "595", "23636", "9817", "5211", "1633", "3682", "1635", "9833", "3693", "622", "5236", "9847", "50810", "1666", "6790", "672", "10915", "3251", "6839", "7866", "4282", "7874", "8900", "9926", "6342", "207", "27346", "79073", "5347", "7398", "90861", "6894", "10491", "8444", "55038", "3329", "11014", "22809", "23326", "11041", "23338", "5427", "10038", "11065", "4927", "10051", "7494", "332", "51021", "51031", "874", "10606", "8050", "80758", "890", "10112", "85377", "25987", "11157", "22934", "26520", "51097", "1445", "51116", "9133", "8624", "10165", "1978", "10174", "55748", "965", "26054", "6599", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "4088", "2553", "1019", "23039"], "VCAP prostate carcinoma": ["7168", "4609", "8204", "2064", "8726", "79902", "10270", "5154", "6697", "10797", "56889", "4154", "10318", "595", "23636", "9817", "5211", "1633", "3682", "1635", "9833", "23658", "3693", "622", "5236", "9847", "1666", "672", "10915", "3251", "6839", "7866", "4282", "7358", "7874", "6342", "9926", "9928", "207", "27346", "79071", "79073", "5347", "7398", "90861", "6894", "10491", "55038", "3329", "22809", "23326", "11041", "23338", "5427", "310", "10038", "11065", "4927", "10051", "7494", "332", "51024", "51031", "874", "8050", "7027", "80758", "890", "8061", "10112", "85377", "11157", "22934", "9112", "26520", "51097", "1445", "51116", "9133", "8624", "1978", "55748", "965", "26054", "6599", "466", "983", "55256", "9181", "991", "993", "994", "5092", "79850", "7153", "7157", "4088", "2553", "1019", "23039"]}, "wortmannin": {"A375 skin malignant melanoma": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "25", "51742", "2597", "1062", "10797", "23597", "9261", "9801", "5710", "1616", "11344", "5720", "54881", "2146", "4200", "23658", "2673", "9847", "8312", "10362", "50814", "644", "84617", "10915", "10921", "2736", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "22908", "8573", "10112", "11137", "387", "55699", "5525", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "983", "9688", "991", "994", "6117", "23013", "7153", "2553", "10237"], "A549 lung non small cell lung cancer| carcinoma": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "51742", "5154", "2597", "1062", "6184", "10797", "23597", "9261", "10813", "9801", "5710", "11344", "5720", "54881", "2146", "23658", "2673", "9847", "8312", "10362", "50814", "8318", "644", "84617", "10915", "5287", "10921", "2736", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "22823", "55604", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "10112", "11137", "387", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "9688", "991", "9695", "994", "23013", "7153", "2553"], "HA1E kidney normal kidney": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "51742", "2597", "1062", "6184", "23597", "9261", "6195", "10813", "9801", "5710", "11344", "54881", "2146", "23658", "2673", "26227", "9847", "8312", "10362", "50814", "644", "10915", "10921", "2736", "5300", "4282", "57019", "9928", "1738", "23244", "5331", "10972", "54499", "55012", "25839", "6390", "11004", "11007", "8985", "23325", "23326", "22823", "55604", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "22908", "10112", "11137", "387", "55699", "5525", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "23463", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "6599", "9688", "9695", "991", "994", "6117", "23013", "7153", "10237"], "HCC515 lung carcinoma": ["91137", "51203", "9221", "9738", "2058", "8204", "23061", "51742", "2597", "1062", "6184", "23597", "1070", "9261", "10813", "9801", "5710", "1616", "11344", "54881", "2146", "4200", "23658", "2673", "9847", "8312", "10362", "50814", "644", "84617", "7319", "10915", "5287", "10921", "2736", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "5925", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "10112", "11137", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "8624", "1978", "1983", "7106", "6597", "965", "9688", "991", "994", "23013", "2542", "7153", "2553", "10237"], "HEPG2 liver hepatocellular carcinoma": ["51203", "9221", "9738", "2058", "8204", "23061", "2582", "25", "51742", "79902", "2597", "1062", "6184", "23597", "9261", "6195", "11319", "9801", "5710", "1616", "11344", "54881", "2146", "4200", "23658", "2673", "9847", "8312", "10362", "50814", "644", "10915", "10921", "50865", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "54499", "55012", "90861", "25839", "6390", "11004", "11007", "22796", "8985", "23325", "23326", "5925", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51021", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "10617", "22908", "10112", "11137", "387", "55699", "5525", "22934", "26520", "93594", "29082", "8607", "1445", "9128", "51116", "64429", "9133", "8624", "1978", "1983", "7106", "6597", "965", "6599", "9688", "994", "6117", "23013", "10237"], "HT29 large intestine colorectal adenocarcinoma": ["91137", "51203", "9221", "9738", "2058", "8204", "23061", "2582", "51742", "2597", "1062", "10797", "9261", "10813", "9801", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "10915", "5287", "10921", "2736", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "22823", "55604", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "10112", "11137", "899", "387", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "983", "9688", "6622", "9695", "991", "994", "23013", "2542", "7153", "2553"], "MCF7 breast adenocarcinoma": ["91137", "51203", "9221", "2058", "9738", "8204", "2582", "25", "51742", "5154", "2597", "1062", "6184", "23597", "9261", "10813", "9801", "5710", "11344", "54881", "2146", "4200", "23658", "58478", "2673", "9847", "8312", "10362", "50814", "8318", "644", "84617", "7319", "5287", "10921", "2736", "50865", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "54499", "5347", "55012", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "22823", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "9688", "9695", "6117", "23013", "2542", "7153"], "PC3 prostate adenocarcinoma": ["91137", "51203", "9221", "9738", "2058", "8204", "2582", "25", "5154", "2597", "1062", "6184", "10797", "9261", "23597", "10813", "9801", "8270", "5710", "11344", "54881", "2146", "4200", "23658", "9847", "10362", "50814", "644", "84617", "10915", "10921", "2736", "5300", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "6390", "55033", "11004", "11007", "8985", "23325", "23326", "22823", "55604", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "51071", "10112", "11137", "387", "899", "55699", "1429", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "10682", "1978", "1983", "7106", "6597", "965", "9688", "991", "994", "23013", "2542", "7153", "2553"], "VCAP prostate carcinoma": ["51203", "9221", "9738", "2058", "8204", "23061", "5154", "2597", "1062", "6184", "23597", "9261", "10813", "9801", "5710", "1616", "11344", "5720", "54881", "2146", "23658", "2673", "9847", "8312", "10362", "50814", "8318", "644", "84617", "10915", "5287", "10921", "2736", "5300", "4282", "57019", "9928", "1738", "23244", "5331", "10972", "5347", "55012", "90861", "25839", "6390", "11004", "11007", "8985", "23325", "23326", "22823", "55604", "10038", "9531", "10557", "5440", "1861", "10059", "332", "51026", "3925", "7511", "57178", "5982", "55148", "51569", "8050", "7027", "10112", "11137", "387", "55699", "22934", "26520", "29082", "93594", "8607", "1445", "9128", "51116", "64429", "9133", "29103", "8624", "1978", "1983", "7106", "6597", "965", "9688", "9695", "991", "994", "6117", "23013", "7153", "5111", "2553", "10237"]}}


def file_name_escaping(filename):
    """
    Make escaping for file names (i.e: omit '|' or '\'.
    :param filename: filename to escape
    :return: escaped filename
    """
    valid_chars = "-_.() %s%s" % (string.ascii_letters, string.digits)
    return ''.join(c for c in filename if c in valid_chars)


class MockModel:

    def predict_latent_space(self, a):
        return a

    def predict_decoder(self, a):
        return a


def mock_get_vectors(self, perturbation, reference_points, tumor):
    """
    Get needed vectors to calculate new cloud, based on the cloud's perturbation
    :param self: self object for mocking
    :param perturbation: perturbation of calculated cloud.
    :param reference_points: tuple of all of the reference points, unused in the mock way
    :param tumor: current tumor, needed to calculate the naive way using the alpha method
    :return: tuple of 2 numpy array: (perturbation_vector, perturbation_and_time_vector).
    """
    p_cloud = self.data.info_df[self.data.info_df.perturbation == perturbation]
    pert_and_time_vectors = []
    current_tumor_end_control_sample = \
        self.data.info_df[(self.data.info_df.tumor == tumor) &
                          (self.data.info_df.perturbation == "DMSO") &
                          (self.data.info_df.pert_time.isin(config.config_map['perturbation_times']))].iloc[0]
    current_tumor_end_control_ref = self.data.reference_points[5].loc[current_tumor_end_control_sample.name]

    current_tumor_start_control_sample = \
        self.data.info_df[(self.data.info_df.tumor == tumor) &
                          (self.data.info_df.perturbation == "DMSO") &
                          (self.data.info_df.pert_time.isin(config.config_map['untreated_times']))].iloc[0]
    current_tumor_start_control_ref = self.data.reference_points[5].loc[current_tumor_start_control_sample.name]
    for t in p_cloud.tumor.unique():
        if t == tumor:
            continue
        t_cloud = self.data.info_df[self.data.info_df.tumor == t]
        treated_sample = p_cloud[p_cloud.tumor == t].iloc[0]
        end_control_sample = t_cloud[(t_cloud.perturbation == "DMSO") & (t_cloud.pert_time.isin(config.config_map['perturbation_times']))].iloc[0]
        start_control_sample = t_cloud[(t_cloud.perturbation == "DMSO") & (t_cloud.pert_time.isin(config.config_map['untreated_times']))].iloc[0]
        treated_ref_point = self.data.reference_points[5].loc[treated_sample.name]
        pert_control_ref_point = self.data.reference_points[5].loc[end_control_sample.name]
        start_control_ref_point = self.data.reference_points[5].loc[start_control_sample.name]
        values = [treated_ref_point.values,
                  pert_control_ref_point.values,
                  start_control_ref_point.values]
        indexes = [0, 1, 2]
        columns = treated_ref_point.index
        cloud_reference_points_df = pd.DataFrame(values, index=indexes, columns=columns)
        latent_space_reference_points_df = cloud_reference_points_df
        latent_treated = latent_space_reference_points_df.iloc[0]
        latent_start_time_control = latent_space_reference_points_df.iloc[2]
        perturbation_and_time_vector = latent_treated - latent_start_time_control
        pert_and_time_vectors.append(perturbation_and_time_vector.values)
    mean_pert_and_time_vector = np.mean(pert_and_time_vectors, axis=0)
    mean_pert_vector = (current_tumor_start_control_ref.values + mean_pert_and_time_vector) - current_tumor_end_control_ref.values
    return mean_pert_vector, mean_pert_and_time_vector


def create_calculated_info_df(base_info_df, info_df, tumor, perturbation):
    calculated_info_df = base_info_df.copy()

    # In any case, just use the info of first perturbation

    # Create info DataFrame and create different index for the calculated
    calculated_info_df.index = 'calculated_{0}_{1}_'.format(tumor, perturbation) + \
                               calculated_info_df['original_index']

    calculated_info_df['arithmetic'] = 'calculated'
    calculated_info_df['perturbation'] = perturbation
    treated_info_df = info_df[(info_df.tumor == tumor) & (info_df.perturbation == perturbation)]
    treated_sample = treated_info_df.iloc[0]

    calculated_info_df['one_hot_labels'] = [treated_sample.one_hot_labels] * calculated_info_df.shape[0]
    calculated_info_df['numeric_labels'] = treated_sample.numeric_labels
    calculated_info_df['pert_time'] = 24
    return calculated_info_df


def calculate_dist_and_corr():
    data = DataHandler()
    model = MockModel()
    output_dir = r"D:\naive"
    if not os.path.isdir(output_dir):
        os.makedirs(output_dir)
    # Change picking reference point function to be by center of cloud
    data.pick_reference_point_function = lambda samples_df: \
        DataHandler.find_reference_point_by_center_of_cloud(model.predict_latent_space, samples_df)
    data.update_reference_points()
    arth = LatentSpaceArithmetic(data, model)
    res = pd.DataFrame(columns=["tumor", "perturbation", "corr", "distance"])
    config.config_map['pictures_folder'] = "d:\\pics"
    i = 0
    data_df, info_df, _ = data.get_all_data_and_info()
    for tumor in info_df.tumor.unique():
        get_vectors_func = lambda self, perturbation, reference_points: mock_get_vectors(self, perturbation, reference_points, tumor)
        arth.get_vectors = MethodType(get_vectors_func, arth)
        for pert in info_df[info_df.tumor == tumor].perturbation.unique():
            if pert == "DMSO":
                continue
            base_samples_info_df = info_df[(info_df.tumor == tumor) & (info_df.perturbation == "DMSO") &
                                           (info_df.pert_time == 6)]
            base_samples_df = data_df.loc[base_samples_info_df.index]
            calculated_real_space_df, _ = arth.calculate_perturbations_effect(base_samples_df, tumor, pert,
                                                                              in_latent_space=True)
            calculated_info_df = create_calculated_info_df(base_samples_info_df, info_df, tumor, pert)
            calculated_real_space_df.index = calculated_info_df.index

            target_info_df = info_df[(info_df.tumor == tumor) & (info_df.perturbation == pert)]
            target_data_df = data_df.loc[target_info_df.index]
            if calculate_top_genes_only:
                try:
                    calculated_real_space_df = calculated_real_space_df[top_genes[pert][tumor]]
                    target_data_df = target_data_df[top_genes[pert][tumor]]
                except KeyError:
                    continue
            statistics = StatisticsCalculator((target_data_df, target_data_df, target_info_df))
            calculated_tuple = (calculated_real_space_df, calculated_real_space_df, calculated_info_df, "_")
            results = statistics.do_statistical_tests(calculated_tuple, "")
            corr = results['calculate to treated corr']
            dist = results['calculate to treated dist']
            res.loc[i] = [tumor, pert, corr, dist]
            i += 1

    res.to_csv(os.path.join(output_dir, "naive.csv"))


def calculate_top_genes(data_df, info_df, tumor, pert):
    treated_info_df = info_df[(info_df.tumor == tumor) & (info_df.perturbation == pert)]
    treated_data_df = data_df.loc[treated_info_df.index]
    control_info_df = info_df[(info_df.tumor == tumor) &
                              (info_df.perturbation.isin(config.config_map['untreated_labels'])) &
                              (info_df.pert_time.isin(config.config_map['untreated_times']))]
    control_data_df = data_df.loc[control_info_df.index]
    control_mean = control_data_df.mean(axis=0)
    treated_mean = treated_data_df.mean(axis=0)
    pert_vectors_df = (treated_mean - control_mean).to_frame()
    top_genes = set(pert_vectors_df[abs(pert_vectors_df[0]) > 0.1].index)
    return top_genes


def naive_intersection():
    """
    Find intersection genes for same drugs between different cell lines, using naive method
    """
    data = DataHandler()
    output_dir = r"D:\naive"
    if not os.path.isdir(output_dir):
        os.makedirs(output_dir)

    data_df, info_df, _ = data.get_all_data_and_info()
    for p in info_df.perturbation.unique():
        if p == "DMSO":
            continue
        pert_cloud = info_df[info_df.perturbation == p]
        results_dict = {}
        for t in pert_cloud.tumor.unique():
            results_dict[t] = calculate_top_genes(data_df, info_df, t, p)

        cell_lines = results_dict.keys()
        res_df = pd.DataFrame(columns=cell_lines, index=cell_lines)
        for c1 in cell_lines:
            for c2 in cell_lines:
                res_df.loc[c1, c2] = len(results_dict[c1].intersection(results_dict[c2]))

        res_df.to_csv(os.path.join(output_dir, "{}.csv".format(p)))
        all_genes = set(data_df.columns)
        for c in cell_lines:
            all_genes = all_genes.intersection(results_dict[c])
        print(p)
        print(all_genes)
        print(len(all_genes))


if __name__ == "__main__":
    calculate_dist_and_corr()
